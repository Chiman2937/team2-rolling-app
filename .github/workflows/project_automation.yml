name: Project V2 Automation

on:
  issues:
    types: [opened, edited, closed]  # ğŸ‘ˆ closed ì´ë²¤íŠ¸ ì¶”ê°€
  pull_request:
    types: [closed]

jobs:
  handle-issues:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Add issue to Project V2 and update Status/Target
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;
            const issueNodeId = issue.node_id;
            const issueNumber = issue.number;
            const body = issue.body || "";

            // â° Target ë‚ ì§œ ì¶”ì¶œ (yml í…œí”Œë¦¿ì— ëŒ€ì‘)
            const targetMatch = body.match(/Target[^\n]*\n+(\d{4}-\d{2}-\d{2})/);
            let targetDate = targetMatch ? targetMatch[1] : null;

            if (!targetDate) {
              const today = new Date();
              targetDate = today.toISOString().slice(0, 10); // yyyy-mm-dd
              console.log(`âš ï¸ Target ë‚ ì§œê°€ ë³¸ë¬¸ì— ì—†ì–´ì„œ ì˜¤ëŠ˜ ë‚ ì§œ(${targetDate})ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.`);
            }

            const username = "Chiman2937";
            const projectNumber = 6;

            const { user } = await github.graphql(`query($login: String!, $number: Int!) {
              user(login: $login) {
                projectV2(number: $number) {
                  id
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                      ... on ProjectV2Field {
                        id
                        name
                        dataType
                      }
                    }
                  }
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }`, { login: username, number: projectNumber });

            const project = user.projectV2;
            const statusField = project.fields.nodes.find(f => f.name === "Status");
            const todoOption = statusField.options.find(o => o.name === "Todo");
            const doneOption = statusField.options.find(o => o.name === "Done");
            const targetField = project.fields.nodes.find(f => f.name === "Target" && f.dataType === "DATE");

            let item = project.items.nodes.find(i => i.content?.id === issueNodeId);
            if (!item) {
              const addResult = await github.graphql(`mutation {
                addProjectV2ItemById(input: {
                  projectId: "${project.id}",
                  contentId: "${issueNodeId}"
                }) {
                  item { id }
                }
              }`);
              item = { id: addResult.addProjectV2ItemById.item.id };
              console.log("âœ… Projectì— ì´ìŠˆê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            // ì´ìŠˆê°€ ë‹«íŒ ê²½ìš° â†’ Statusë¥¼ Doneìœ¼ë¡œ ì„¤ì •
            if (context.payload.action === 'closed' && statusField && doneOption) {
              await github.graphql(`mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${project.id}",
                  itemId: "${item.id}",
                  fieldId: "${statusField.id}",
                  value: { singleSelectOptionId: "${doneOption.id}" }
                }) {
                  projectV2Item { id }
                }
              }`);
              console.log("âœ… ì´ìŠˆê°€ ë‹«í˜€ì„œ Statusë¥¼ Doneìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.");
            }

            // ì´ìŠˆê°€ ì—´ë¦° ê²½ìš° or í¸ì§‘ëœ ê²½ìš° â†’ Statusë¥¼ Todoë¡œ ì„¤ì •
            if ((context.payload.action === 'opened' || context.payload.action === 'edited') && statusField && todoOption) {
              await github.graphql(`mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${project.id}",
                  itemId: "${item.id}",
                  fieldId: "${statusField.id}",
                  value: { singleSelectOptionId: "${todoOption.id}" }
                }) {
                  projectV2Item { id }
                }
              }`);
              console.log("âœ… Status í•„ë“œë¥¼ Todoë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.");
            }

            // Target ë‚ ì§œ ì„¤ì • (ëª¨ë“  ê²½ìš°)
            if (targetField && targetDate) {
              await github.graphql(`mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${project.id}",
                  itemId: "${item.id}",
                  fieldId: "${targetField.id}",
                  value: { date: "${targetDate}" }
                }) {
                  projectV2Item { id }
                }
              }`);
              console.log(`âœ… Target í•„ë“œì— ë‚ ì§œ ${targetDate} ë°˜ì˜ ì™„ë£Œ.`);
            }

  handle-closed-pr:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Update linked issues to Done
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const username = "Chiman2937";
            const projectNumber = 6;
            const prBody = context.payload.pull_request.body || "";
            const issueNumbers = [...prBody.matchAll(/fixes\s+#(\d+)/gi)].map(m => m[1]);

            const { user } = await github.graphql(`query($login: String!, $number: Int!) {
              user(login: $login) {
                projectV2(number: $number) {
                  id
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }`, { login: username, number: projectNumber });

            const project = user.projectV2;
            const statusField = project.fields.nodes.find(f => f.name === "Status");
            const doneOption = statusField.options.find(o => o.name === "Done");

            for (const number of issueNumbers) {
              const issue = await github.rest.issues.get({
                owner: username,
                repo: context.repo.repo,
                issue_number: number
              });

              const issueNodeId = issue.data.node_id;

              let itemId;
              try {
                const result = await github.graphql(`mutation {
                  addProjectV2ItemById(input: {
                    projectId: "${project.id}",
                    contentId: "${issueNodeId}"
                  }) {
                    item { id }
                  }
                }`);
                itemId = result.addProjectV2ItemById.item.id;
              } catch {
                console.log(`â„¹ï¸ Issue #${number} ì´ë¯¸ ì¶”ê°€ë˜ì—ˆì„ ìˆ˜ ìˆìŒ. í•„ë“œë§Œ ì—…ë°ì´íŠ¸.`);
              }

              await github.graphql(`mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${project.id}",
                  itemId: "${itemId}",
                  fieldId: "${statusField.id}",
                  value: { singleSelectOptionId: "${doneOption.id}" }
                }) {
                  projectV2Item { id }
                }
              }`);
              console.log(`âœ… Issue #${number}ì˜ Statusë¥¼ Doneìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
